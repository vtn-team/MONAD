# MONAD プロジェクト解析

## サーバサイド

### 思想： Write is Justice

とりあえず手を動かそう、動けば正義だ  
動かすまではTypeScriptがやってくれる  
気になれば後から書き直せばいい


### 概要
- ゲームサーバとAPIサーバをドッキングした形式にしている
  - ゲームサーバは分散予定
- ゲームサーバとAPI両方から参照する可能性があるため、ロジックはなるべくvclogicに書く
- gameserver内のcontentsはコンテンツごとの専用コードが書かれる(ここはオンメモリで対応するのでvclogicに書かなくてよい)
- server内のコードはAPI参照のため、ロジックはあまり持たないようにする

## プロダクト概要

MONADは、知識グラフを構築・可視化するためのシステムです。主に以下の機能を持っています：

1. **知識グラフの構築と管理**：
   - Notionデータベースと連携して情報を取得・保存
   - Neo4jグラフデータベースを使用して知識間の関連性を保存・管理
   - ページ、単語、ノートなどの異なるタイプのデータを扱う

2. **WebSocketベースのリアルタイム通信**：
   - クライアント-サーバー間のリアルタイム通信
   - セッション管理機能

3. **AI統合**：
   - OpenAI (GPT)、Anthropic (Claude)、Google (Gemini) のAI APIと連携
   - 複数のAIモデルを比較・評価する機能

4. **グラフ可視化**：
   - Cytoscapeを使用したグラフ可視化インターフェース
   - 関連する単語やコンセプトの関係性を視覚的に表示

## ファイル配置規則

MONADプロジェクトのファイル構造は以下のような規則に従っています：

### メインディレクトリ
- `ts/`: TypeScriptソースコード
- `js/`: コンパイル後のJavaScriptファイル
- `json/`: 設定ファイルやマスターデータ
- `view/`: フロントエンドのHTMLファイルやクライアントサイドスクリプト

### TypeScriptディレクトリ構造
- `ts/config/`: 設定ファイル（APIキーなど）
- `ts/lib/`: 共通ライブラリ（データベース接続、AI API連携など）
- `ts/server/`: APIエンドポイント実装
- `ts/gameserver/`: WebSocketベースのゲームサーバー実装
- `ts/monad/`: MONADコアロジック（データスキーマ、Notion連携など）
- `ts/vclogic/`: 共有ロジック（ゲームサーバとAPIサーバの両方から参照される）
- `ts/test/`: テストコード

### コード構成パターン
- `main.ts`: アプリケーションのエントリーポイント
- `server.ts`: HTTPサーバーの実装
- `apiRoute.ts`: APIルーティング定義
- データアクセスは階層化されており、高レベルのロジック（`monad/`）→ 中間層（`lib/`）→ 低レベルのAPI（外部サービス）という流れ

## 未実装・不足している部分

1. **フロントエンド開発**:
   - 現状のフロントエンドは最小限の実装（`view/index.html`と`view/graph.html`）
   - モバイル対応やレスポンシブデザインが不十分
   - ユーザー体験を向上させるためのUIコンポーネントが少ない

2. **認証・認可システム**:
   - Googleログイン機能は実装されているが、権限管理や詳細なユーザー管理機能が不足
   - セッション管理の実装は基本的なレベル

3. **エラーハンドリング**:
   - 多くの関数でエラーハンドリングが不十分（単純なconsole.logのみ）
   - ユーザーへのエラー通知メカニズムが不足

4. **テスト**:
   - 単体テストやE2Eテストが不足
   - `ts/test/`ディレクトリにいくつかのテストファイルはあるが、網羅的ではない

5. **ドキュメント**:
   - コードコメントが日本語と英語が混在しており、一部文字化けしている箇所がある
   - APIドキュメントやセットアップガイドが不足

6. **データバックアップと復元**:
   - Neo4jとNotionのデータバックアップ・復元メカニズムが明示的に実装されていない

## コードの問題点

1. **文字化け**:
   - 多くのファイルで日本語コメントが文字化けしている（特にts/monad/notionData.tsなど）
   - エンコーディングの問題が発生している可能性がある

2. **エラーハンドリング**:
   - 多くの関数で例外をキャッチしているが、適切な対応（リトライやフォールバック）がない
   - ユーザーへのエラー通知が不足

3. **設定管理**:
   - 設定ファイル（`ts/config/config.ts`）がバージョン管理されておらず、サンプルファイルのみ
   - 環境変数との連携が不十分

4. **型の使用**:
   - TypeScriptの型システムが十分に活用されていない箇所がある
   - `any`型の過剰使用（特にAPIレスポンスの処理など）

5. **コード重複**:
   - AI連携部分（chatgpt.ts, claude.ts, gemini.ts）で類似コードの重複がある
   - 共通インターフェースやアダプターパターンの活用が不足

6. **非同期処理**:
   - 一部の非同期処理でawaitが適切に使用されていない
   - Promiseチェーンの扱いが不適切な箇所がある

7. **セキュリティ**:
   - クライアントサイドでのセキュリティ対策が不足
   - APIキーなどの機密情報の管理が不十分

8. **パフォーマンス**:
   - Neo4jとNotionの連携部分でパフォーマンス最適化の余地がある
   - キャッシュ戦略が明確でない

## 今後の改善点

1. **フロントエンド強化**:
   - モダンなフロントエンドフレームワーク（React, Vue, Svelteなど）の導入
   - ユーザー体験の向上

2. **コード品質向上**:
   - TypeScriptの型システムを活用したコードの堅牢性向上
   - エラーハンドリングの改善
   - コードの重複排除

3. **テスト強化**:
   - 単体テスト、統合テスト、E2Eテストの追加
   - CI/CDパイプラインの構築

4. **ドキュメント整備**:
   - APIドキュメントの作成
   - セットアップガイドの整備
   - コードコメントの統一（言語、フォーマット）

5. **セキュリティ強化**:
   - 認証・認可システムの強化
   - 機密情報管理の改善
   - セキュリティ監査の実施

6. **スケーラビリティ対応**:
   - マイクロサービスアーキテクチャへの移行検討
   - コンテナ化（Docker, Kubernetes）の検討
